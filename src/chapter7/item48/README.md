## 7장 - 람다와 스트림

### <아이템48 > 스트림 병렬화는 주의해서 적용하라 

> **(요약)** 계산도 올바로 수행하고 성능도 빨라질 거라는 확신 없이는 스트림 파이프라인 병렬화는 시도조차 하지 말라. 스트림을 잘못 병렬화하면 프로그램을 오동작하게 하거나 성능을 급격히 떨어뜨린다.

주류 언어 중, 동시성 프로그래밍 측면에서 자바는 항상 앞서갔다.

- 처음 릴리즈 된 1996년부터는 스레드, 동기화, wait/notify를 지원했다.
- 자바 5부터는 동시성 컬렉션인 java.util.concurrent 라이브러리와 실행자(Executor) 프레임워크를 지원했다.
- 자바 7부터는 고성능 병렬 분해(parallel decom-position) 프레임워크인 포크-조인(fork-join) 패키지를 추가했다.
- 자바 8부터는 parallel 메서드를 한 번 호출하면 파이프라인을 병렬 실행할 수 있는 스트림을 지원했다.

이처럼 자바로 동시성 프로그램을 작성하기가 점점 쉬워지고 있지만, 이를 올바르고 빠르게 작성하는 일은 여전히 어려운 작업이다.

동시성 프로그래밍을 할 때는

- 안정성(safety)
- 응답 가능(liveness)

상태를 유지하기 위해 애써야 한다.

[Item48.java](https://github.com/ziippy/EffectiveJava/blob/master/src/chapter7/item48/Item48.java) 에서 구현된 메르센 소수 생성 프로그램에서, 단순히 .parallel() 을 추가한다고 해서 성능이 올라가지 않는다.

- 이유는? 스트림 라이브러리가 이 파이프라인을 병렬화하는 방법을 찾아내지 못했기 때문이다.

환경이 아무리 좋더라도 **데이터 소스가 Stream.iterator 이거나 중간 연산으로 limit 을 쓰면 파이프라인 병렬화로는 성능 개선을 기대할 수 없다.

<span style='color:skyblue'>스트림 파이프라인을 마구잡이로 병렬화하면 안 된다. 성능이 오히려 끔찍하게 나빠질 수도 있다.</span>

<span style='color:skyblue'>스트림을 잘못 병렬화하면 (응답 불가를 포함해) 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있다.</span>

<span style='color:skyblue'>조건이 잘 갖춰지면 parallel 메서드 호출 하나로 거의 프로세서 코어 수에 비례하는 성능 향상을 만끽할 수 있다.</span>

대체로

- 스트림의 소스가 ArrayList, HashMap, HashSet, ConcurrentHashMap 의 인스턴스이거나 배열, int 범위, long 범위일 때 병렬화의 효과가 가장 좋다.
  - 이 자료구조들은 모두 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어서, 일을 다수의 스레드에 분배하기에 좋다는 특징이 있다.
